name: ubuntu based multi-arch images w/o wireguard-tools

env:
  IMAGE: nordlynx-proxy
  TAG: latest
  PUSH: true
  BASE_IMAGE: ubuntu:24.04
  WG: false # true
  PTF: "linux/amd64,linux/arm64"
  # no dante-server on ubuntu 24.04 for armhf

on:
  workflow_dispatch:
    inputs:
      mypush:
        type: boolean
        default: true
        description: "push true/false"
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - '.github/**'
      - 'README.md'

jobs:
    determine-push:
      runs-on: ubuntu-latest
      outputs:
        push: ${{ steps.set.outputs.push }}
      steps:
        - name: set push value
          id: set
          run: |
            if [ "${{ github.event_name }}" = "push" ]; then
              echo "push=true" >> "$GITHUB_OUTPUT"
            else
              # pour workflow_dispatch on lit l'input (par dÃ©faut true)
              echo "push=${{ github.event.inputs.push != '' && github.event.inputs.push || 'true' }}" >> "$GITHUB_OUTPUT"
            fi
    envtooutput:
      runs-on: ubuntu-latest
      outputs:
        image: ${{ env.IMAGE }}
        tag: ${{ env.TAG }}
        ptf: ${{ env.PTF }}
        base_image: ${{ env.BASE_IMAGE }}
        push: "${{ needs.determine-push.outputs.push }}"
        wg: "${{ env.WG }}"
      steps:
        - name: dummy task to get outputs.
          run: |
            ls -al
            export

    build-ubuntu-nowg:
      needs: envtooutput
      uses: ./.github/workflows/buildPush_template.yml
      with:
        image: "${{ needs.envtooutput.outputs.image }}"
        tag: "${{ needs.envtooutput.outputs.tag }}"
        ptf: "${{ needs.envtooutput.outputs.ptf }}"
        base_image: "${{ needs.envtooutput.outputs.base_image }}"
        #push: false
        push: ${{ needs.envtooutput.outputs.push }}
        wg: false
      secrets: inherit

    build-ubuntu-wg:
      needs: envtooutput
      uses: ./.github/workflows/buildPush_template.yml
      with:
        image: "${{ needs.envtooutput.outputs.image }}"
        tag: "${{ needs.envtooutput.outputs.tag }}"
        ptf: "${{ needs.envtooutput.outputs.ptf }}"
        base_image: "${{ needs.envtooutput.outputs.base_image }}"
        #push: false
        push: ${{ needs.envtooutput.outputs.push == 'true' }}
        wg: true
      secrets: inherit